save_handler = {}

#include !/common/utils
#include guids
#include names
#include positions
#include info
#include preparation
#include scenarios
#include achievements
#include unlocked
#include characters

save_handler.SAVE_FILE = "Savefile"

function save_handler.read()
  local save_file = utils.read_notebook(save_handler.SAVE_FILE)

  if not save_file then
    print("No notebook found containing the save file! Please add a notebook named " .. save_handler.SAVE_FILE)
    return
  end

  local content = JSON.decode(save_file)

  preparation.start(function() save_handler.start_reading(content) end)
end


function save_handler.start_reading(content)
  save_handler.read_global(content.global)
  save_handler.read_unlocked(content.unlocked)
  save_handler.read_party(content.party)
end


function save_handler.read_global(content)
  if not content then return end

  if content.scenarios then
    scenarios.read_all(content.scenarios)
  end
  if content.achievements then
    achievements.read_all(content.achievements)
  end
  save_handler.__read_prosperity(content)
end


function save_handler.__read_prosperity(content)
  if content.prosperity then
    print("Reading prosperity.")
    local map_script = getObjectFromGUID(guids.MAP)
    for i = 1, content.prosperity do
      map_script.call("clickedPros", i)
    end
  end
end


function save_handler.read_unlocked(content)
  if not content then return end

  if content.classes then
    unlocked.read_classes(content.classes)
  end
end


function save_handler.read_party(content)
  if not content then return end

  save_handler.read_party_base(content)
  save_handler.read_characters(content)
end


function save_handler.read_party_base(party)
  local party_sheet = getObjectFromGUID(guids.PARTY_SHEET)

  if party.name then
    party_sheet.UI.setAttribute("partyName", "text", party.name)
    party_sheet.setName(party.name)
  end
  if party.location then
    party_sheet.UI.setAttribute("location", "text", party.location)
  end
  if party.notes then
    party_sheet.UI.setAttribute("notes", "text", table.concat(party.notes, "\n"))
  end
  if party.achievements then
    party_sheet.UI.setAttribute("partyAchiev", "text", table.concat(party.achievements, "\n"))
  end
  if party.reputation then
    party_sheet.call("addSub", {"partyReputation", party.reputation})
  end
end


function save_handler.read_characters(party)
  if party.characters then
    characters.read_all(party.characters)
  end
end
